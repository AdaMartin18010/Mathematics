# 模块系统概述 | Module System Overview

## 概述 | Overview

Lean的模块系统是构建大型数学库的基础。它提供了命名空间、导入导出、依赖管理等机制，使得复杂的数学理论能够被组织成清晰、可维护的结构。

Lean's module system is the foundation for building large mathematical libraries. It provides mechanisms for namespaces, import/export, dependency management, and more, enabling complex mathematical theories to be organized into clear, maintainable structures.

## 基本模块概念 | Basic Module Concepts

### 1. 文件作为模块 | Files as Modules

```lean
-- 文件: MyModule.lean
-- 每个.lean文件都是一个模块 | Each .lean file is a module

-- 定义模块内容 | Define module content
def myFunction (x : Nat) : Nat := x + 1

-- 导出定义 | Export definitions
export MyModule (myFunction)
```

### 2. 命名空间 | Namespaces

```lean
-- 创建命名空间 | Create namespace
namespace Math
  -- 在命名空间内定义 | Define within namespace
  def add (x y : Nat) : Nat := x + y
  def multiply (x y : Nat) : Nat := x * y
  
  -- 命名空间内的类型 | Types within namespace
  structure Point where
    x : Float
    y : Float
    deriving Repr
end Math

-- 访问命名空间内容 | Access namespace content
#check Math.add
#check Math.multiply
#check Math.Point
```

### 3. 导入系统 | Import System

```lean
-- 导入其他模块 | Import other modules
import Mathlib.Data.Nat.Basic
import Mathlib.Data.List.Basic
import Mathlib.Algebra.Group.Basic

-- 使用导入的内容 | Use imported content
#check Nat.add
#check List.map
#check Group
```

## 模块组织结构 | Module Organization Structure

### 1. 层次化组织 | Hierarchical Organization

```lean
-- 顶层模块 | Top-level module
-- Mathlib/
--   ├── Data/
--   │   ├── Nat/
--   │   │   ├── Basic.lean
--   │   │   └── Order.lean
--   │   └── List/
--   │       ├── Basic.lean
--   │       └── Operations.lean
--   └── Algebra/
--       ├── Group/
--       │   └── Basic.lean
--       └── Ring/
--           └── Basic.lean

-- 示例：数据模块 | Example: Data module
namespace Data
  namespace Nat
    -- 自然数基本操作 | Basic natural number operations
    def succ (n : Nat) : Nat := n + 1
    def pred (n : Nat) : Nat := n - 1
  end Nat
  
  namespace List
    -- 列表基本操作 | Basic list operations
    def head [Inhabited α] (xs : List α) : α :=
      match xs with
      | [] => default
      | x :: _ => x
  end List
end Data
```

### 2. 依赖关系管理 | Dependency Management

```lean
-- 模块依赖示例 | Module dependency example
-- Basic.lean 依赖 | Basic.lean dependencies
import Mathlib.Init.Core
import Mathlib.Init.Data.Nat.Basic

-- Order.lean 依赖 | Order.lean dependencies
import Mathlib.Data.Nat.Basic  -- 依赖Basic.lean
import Mathlib.Init.Data.Nat.Order

-- 避免循环依赖 | Avoid circular dependencies
-- Basic.lean 不应该导入 Order.lean
-- Order.lean 可以导入 Basic.lean
```

## 模块接口设计 | Module Interface Design

### 1. 公共接口 | Public Interface

```lean
-- 定义公共接口 | Define public interface
namespace PublicInterface
  -- 公共类型 | Public types
  structure Vector (α : Type) (n : Nat) where
    data : List α
    length_eq : data.length = n
    deriving Repr
  
  -- 公共函数 | Public functions
  def Vector.get (v : Vector α n) (i : Nat) (h : i < n) : α :=
    v.data.get! i
  
  def Vector.set (v : Vector α n) (i : Nat) (h : i < n) (x : α) : Vector α n :=
    { data := v.data.set! i x, length_eq := v.length_eq }
  
  -- 导出公共接口 | Export public interface
  export PublicInterface (Vector, Vector.get, Vector.set)
end PublicInterface
```

### 2. 私有实现 | Private Implementation

```lean
-- 私有实现细节 | Private implementation details
namespace PrivateImplementation
  -- 私有辅助函数 | Private helper functions
  private def validateIndex (i : Nat) (n : Nat) : Bool :=
    i < n
  
  private def safeGet (xs : List α) (i : Nat) : Option α :=
    xs.get? i
  
  -- 公共函数使用私有实现 | Public functions use private implementation
  def safeVectorGet (v : Vector α n) (i : Nat) : Option α :=
    if validateIndex i n then
      safeGet v.data i
    else
      none
end PrivateImplementation
```

## 模块配置 | Module Configuration

### 1. 编译选项 | Compilation Options

```lean
-- 设置编译选项 | Set compilation options
set_option autoImplicit false
set_option pp.unicode true
set_option pp.proofs false

-- 模块特定选项 | Module-specific options
namespace MyModule
  -- 在此命名空间内应用选项 | Apply options within this namespace
  set_option pp.unicode false
  
  def myFunction : Nat := 42
end MyModule
```

### 2. 属性配置 | Attribute Configuration

```lean
-- 设置属性 | Set attributes
@[simp] theorem add_zero (a : Nat) : a + 0 = a := by
  rfl

@[inline] def fastAdd (x y : Nat) : Nat := x + y

@[export] def exportedFunction (x : Nat) : Nat := x * 2

-- 批量设置属性 | Batch set attributes
attribute [simp] add_zero add_comm add_assoc
attribute [inline] fastAdd fastMultiply
```

## 模块测试 | Module Testing

### 1. 单元测试 | Unit Testing

```lean
-- 模块单元测试 | Module unit testing
namespace ModuleTests
  -- 测试基本功能 | Test basic functionality
  def testAdd : Bool :=
    let result := 2 + 3
    result = 5
  
  def testMultiply : Bool :=
    let result := 4 * 5
    result = 20
  
  -- 测试边界情况 | Test edge cases
  def testZero : Bool :=
    let result := 0 + 0
    result = 0
  
  def testLargeNumbers : Bool :=
    let result := 1000 * 1000
    result = 1000000
  
  -- 运行测试 | Run tests
  #eval testAdd
  #eval testMultiply
  #eval testZero
  #eval testLargeNumbers
end ModuleTests
```

### 2. 集成测试 | Integration Testing

```lean
-- 模块集成测试 | Module integration testing
namespace IntegrationTests
  -- 测试模块间交互 | Test inter-module interaction
  def testModuleInteraction : Bool :=
    let basic := Data.Nat.succ 5
    let result := Data.List.head [basic]
    result = 6
  
  -- 测试复杂场景 | Test complex scenarios
  def testComplexScenario : Bool :=
    let numbers := [1, 2, 3, 4, 5]
    let doubled := numbers.map (· * 2)
    let sum := doubled.foldl (· + ·) 0
    sum = 30
  
  #eval testModuleInteraction
  #eval testComplexScenario
end IntegrationTests
```

## 模块文档 | Module Documentation

### 1. 模块级文档 | Module-Level Documentation

```lean
-- 模块文档 | Module documentation
/--
# 数学基础模块 | Basic Mathematics Module

这个模块提供了基础的数学操作和类型定义。

This module provides basic mathematical operations and type definitions.

## 主要功能 | Main Features

- 自然数操作 | Natural number operations
- 列表操作 | List operations
- 基本代数结构 | Basic algebraic structures

## 使用示例 | Usage Examples

```lean
#eval Data.Nat.succ 5  -- 结果: 6
#eval Data.List.head [1, 2, 3]  -- 结果: 1
```

## 依赖关系 | Dependencies

- `Mathlib.Init.Core`
- `Mathlib.Init.Data.Nat.Basic`

```lean
namespace MathBasic
  -- 模块实现 | Module implementation
end MathBasic

```

### 2. 函数级文档 | Function-Level Documentation

```lean
-- 函数文档 | Function documentation
/--
计算两个自然数的和。

Computes the sum of two natural numbers.

## 参数 | Parameters

- `x`: 第一个自然数 | First natural number
- `y`: 第二个自然数 | Second natural number

## 返回值 | Return Value

两个自然数的和 | Sum of the two natural numbers

## 示例 | Examples

```lean
#eval add 3 4  -- 结果: 7
#eval add 0 5  -- 结果: 5
```

## 复杂度 | Complexity

时间复杂度: O(1) | Time complexity: O(1)
空间复杂度: O(1) | Space complexity: O(1)

```lean
def add (x y : Nat) : Nat := x + y

```

## 最佳实践 | Best Practices

### 1. 模块设计原则 | Module Design Principles

```lean
-- 单一职责原则 | Single responsibility principle
-- 每个模块应该有一个明确的职责 | Each module should have a clear responsibility

-- 好的设计 | Good design
namespace Data.Nat
  -- 只处理自然数相关操作 | Only handle natural number operations
  def succ (n : Nat) : Nat := n + 1
  def pred (n : Nat) : Nat := n - 1
end Data.Nat

-- 避免的设计 | Avoid design
namespace Everything
  -- 不要把所有功能放在一个模块中 | Don't put all functionality in one module
  def natAdd (x y : Nat) : Nat := x + y
  def stringConcat (s1 s2 : String) : String := s1 ++ s2
  def listMap (f : α → β) (xs : List α) : List β := xs.map f
end Everything
```

### 2. 依赖管理 | Dependency Management

```lean
-- 最小化依赖 | Minimize dependencies
-- 只导入必要的模块 | Only import necessary modules

-- 好的依赖管理 | Good dependency management
import Mathlib.Data.Nat.Basic  -- 只导入需要的部分 | Only import needed parts

-- 避免的依赖管理 | Avoid dependency management
-- import Mathlib  -- 不要导入整个库 | Don't import entire library
```

## 相关链接 | Related Links

- [02-依赖管理](./02-依赖管理/README.md)
- [03-命名空间设计](./03-命名空间设计/README.md)
- [数学库架构](../../README.md)

## 练习 | Exercises

1. 设计一个模块的层次结构
2. 实现模块间的依赖关系
3. 创建模块的测试套件

---

*最后更新：2025年1月*
*版本：1.0*
