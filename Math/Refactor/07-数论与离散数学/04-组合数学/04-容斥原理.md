---
title: "容斥原理"
date: 2025-07-04
---

## 1. 超出基本原理的计数问题

我们已经学习了加法原理和乘法原理。但如果一个问题中的"类别"不是互斥的，而是有重叠的，应该怎么办？

**简单例子**:
一个班里，有15个学生喜欢足球，20个学生喜欢篮球，其中有5个学生两种球都喜欢。问只喜欢足球**或**篮球的学生总共有多少人？

- **错误的做法**: $15 + 20 = 35$。这个计算把那5个两种球都喜欢的学生数了两次。
- **正确的做法**: 为了纠正这个错误，我们需要减去被重复计算的部分。
    总人数 = (喜欢足球的人) + (喜欢篮球的人) - (两种都喜欢的人)
    总人数 = $15 + 20 - 5 = 30$ 人。

这个简单的"加上全部，减去重叠"的思想，就是容斥原理的基础。

---

## 2. 容斥原理 (The Principle of Inclusion-Exclusion)

容斥原理提供了一个通用的公式，用来计算多个具有重叠元素的集合的并集大小。

**两个集合的情况**:
对于任意两个集合 $A_1, A_2$：
$$ |A_1 \cup A_2| = |A_1| + |A_2| - |A_1 \cap A_2| $$

**三个集合的情况**:
对于任意三个集合 $A_1, A_2, A_3$：
$$ |A_1 \cup A_2 \cup A_3| = (|A_1| + |A_2| + |A_3|) - (|A_1 \cap A_2| + |A_1 \cap A_3| + |A_2 \cap A_3|) + |A_1 \cap A_2 \cap A_3| $$

- **逻辑**:
    1. **加上**所有单个集合的大小。
    2. **减去**所有两个集合的交集大小（修正被重复计算的元素）。
    3. **加上**所有三个集合的交集大小（因为在第2步中，这些元素被减多了，需要加回来）。

**普遍形式**:
对于 $n$ 个集合 $A_1, A_2, \dots, A_n$：
$$ |\bigcup_{i=1}^{n} A_i| = \sum_{i} |A_i| - \sum_{i<j} |A_i \cap A_j| + \sum_{i<j<k} |A_i \cap A_j \cap A_k| - \dots + (-1)^{n-1} |A_1 \cap \dots \cap A_n| $$
这个公式的模式是：**交替地加上和减去**不同数量集合的交集大小。这也就是"容"和"斥"的含义。

---

## 3. 应用：错排问题 (Derangement)

容斥原理最经典的应用之一是解决**错排问题**。

**问题描述**:
$n$ 个人写了 $n$ 封信，并准备了 $n$ 个写好正确地址的信封。如果他们随机地将信放入信封，问恰好**没有一封信**放对信封的情况有多少种？
这个数量记作 $D_n$ 或 $!n$。

**使用容斥原理求解**:

- **全集 $U$**: 所有可能的放信方式，即 $n$ 封信的全排列，所以 $|U| = n!$。
- **目标**: 我们要求的是**不满足任何一个"放对"条件**的数量。这等价于用全集减去**至少有一个放对**的数量。
- **定义属性**: 让属性 $P_i$ 表示"第 $i$ 封信放对了信封"。我们要计算的是 $|P_1 \cup P_2 \cup \dots \cup P_n|$ 的大小。
- **计算交集大小**:
  - $|P_i|$: 第 $i$ 封信放对了，剩下的 $n-1$ 封信可以任意放。方法数是 $(n-1)!$。这样的属性有 $\binom{n}{1}$ 个。
        $\sum |P_i| = \binom{n}{1}(n-1)! = \frac{n!}{1! (n-1)!} (n-1)! = \frac{n!}{1!}$。
  - $|P_i \cap P_j|$: 第 $i$ 和第 $j$ 封信都放对了，剩下的 $n-2$ 封信可以任意放。方法数是 $(n-2)!$。这样的交集有 $\binom{n}{2}$ 个。
        $\sum |P_i \cap P_j| = \binom{n}{2}(n-2)! = \frac{n!}{2! (n-2)!} (n-2)! = \frac{n!}{2!}$。
  - ...
  - $|P_{i_1} \cap \dots \cap P_{i_k}|$: $k$ 封信放对了，方法数是 $(n-k)!$。这样的交集有 $\binom{n}{k}$ 个。
        $\sum |P_{i_1} \cap \dots \cap P_{i_k}| = \binom{n}{k}(n-k)! = \frac{n!}{k!}$。

- **应用容斥原理**:
    至少有一封信放对的方法数是：
    $|\bigcup P_i| = \frac{n!}{1!} - \frac{n!}{2!} + \frac{n!}{3!} - \dots + (-1)^{n-1} \frac{n!}{n!}$

- **计算最终结果**:
    $D_n$ (全错排数) = (总数) - (至少一个对)
    $D_n = n! - \left( \frac{n!}{1!} - \frac{n!}{2!} + \frac{n!}{3!} - \dots + (-1)^{n-1} \frac{n!}{n!} \right)$
    $D_n = n! \left( 1 - \frac{1}{1!} + \frac{1}{2!} - \frac{1}{3!} + \dots + (-1)^n \frac{1}{n!} \right)$
    $D_n = n! \sum_{k=0}^{n} \frac{(-1)^k}{k!}$

这个结果非常有趣，因为括号里的级数是自然对数的底 $e$ 的泰勒展开式 $e^x = \sum \frac{x^k}{k!}$ 在 $x=-1$ 时的部分和。因此，$D_n$ 约等于 $\frac{n!}{e}$，并且是与 $\frac{n!}{e}$ 最接近的整数。

## 4. 总结

容斥原理是一个处理复杂计数问题的强大工具，其核心思想可以概括为：

1. **正向计算困难，逆向思考**：当直接计算"恰好满足/不满足某些条件"很困难时，转而计算"至少满足一个条件"的情况，再用全集去减。
2. **系统地修正错误**：通过交替地加减（容斥），系统地修正因集合重叠而导致的重复计数。

它将看似混乱的重叠问题，转化为对一系列交集大小的清晰计算，是组合数学中从初级到高级思维方式转变的重要一步。
