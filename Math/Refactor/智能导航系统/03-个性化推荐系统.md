# 03-个性化推荐系统

## 📊 系统概述

- **系统名称**: Refactor个性化推荐系统
- **核心功能**: 基于用户画像与协同过滤的个性化内容推荐
- **技术栈**: Python + FastAPI + Matrix Factorization + ANN
- **目标指标**: 推荐点击率 > 15%，Top-K 命中率 > 40%

---

## 🎯 核心功能设计

### 1. 用户画像构建

#### 1.1 画像维度

- **兴趣主题**: 代数/分析/几何/拓扑/逻辑/数论/跨学科
- **难度偏好**: 入门/基础/进阶/研究
- **学习行为**: 搜索词、点击、停留时长、跳出率
- **进度轨迹**: 完成度、访问顺序、路径长度

#### 1.2 画像生成

```python
class UserProfiler:
    def __init__(self):
        self.decay_factor = 0.85
    
    def build_profile(self, events):
        profile = {
            'interests': self.aggregate_interests(events),
            'difficulty': self.estimate_difficulty(events),
            'sequence_patterns': self.mine_sequences(events)
        }
        return profile
```

### 2. 推荐算法

#### 2.1 基于内容的推荐（CB）

- 语义向量：SentenceTransformer 文档嵌入
- 概念标签：知识图谱概念与关系特征
- 匹配策略：余弦相似度 + 概念覆盖率加权

```python
class ContentBasedRecommender:
    def recommend(self, query_vec, candidate_matrix, top_k=10):
        scores = cosine_similarity(query_vec, candidate_matrix)
        return np.argsort(-scores)[:top_k]
```

#### 2.2 协同过滤（CF）

- 基于矩阵分解：ALS/BPR
- 基于近邻：ANN（Faiss/HNSW）加速相似用户/内容检索

```python
class MatrixFactorizationCF:
    def __init__(self, num_factors=64):
        self.num_factors = num_factors
    
    def fit(self, R):
        # 训练隐向量（省略）
        pass
    
    def recommend(self, user_id, top_k=10):
        # 计算评分并取Top-K（省略）
        pass
```

#### 2.3 混合推荐（Hybrid）

- 融合策略：线性加权 + 学习排序（LambdaMART/LightGBM）
- 特征：CB相似度、CF分数、点击率、停留时长、难度匹配度、主题覆盖率

```python
class HybridRecommender:
    def __init__(self, cb_model, cf_model, ranker):
        self.cb = cb_model
        self.cf = cf_model
        self.ranker = ranker
    
    def recommend(self, user, query_vec, candidates, top_k=10):
        cb_scores = self.cb.score(query_vec, candidates)
        cf_scores = self.cf.score(user, candidates)
        features = self.build_feature_matrix(cb_scores, cf_scores, candidates)
        ranked = self.ranker.rank(features)
        return ranked[:top_k]
```

### 3. 冷启动与多样性

#### 3.1 冷启动

- 新用户：基于热门+问卷引导+向量检索的最近邻冷启动
- 新内容：基于内容特征的近邻召回 + 知识图谱邻域扩散

#### 3.2 多样性与新颖性

- 结果去冗余：MMR/DPP
- 新颖性控制：基于历史曝光的惩罚项

### 4. 在线服务与反馈闭环

#### 4.1 在线服务

- FastAPI 提供 `/recommend` `/feedback` `/profile` 接口
- Redis 缓存 Top-K 候选与用户画像
- 定时任务离线训练、在线热加载

#### 4.2 反馈学习

- 点击/停留/完成度作为正负样本
- 周期性训练学习排序模型

---

## 🧪 评估与指标

- **离线**: Recall@K, NDCG@K, MAP, Coverage
- **在线**: CTR, CVR, Dwell Time, 跳出率, 路径完成率
- **鲁棒**: 冷启动用户覆盖率、长尾内容曝光率

---

## 🏗️ 架构设计

```text
推荐系统/
├── offline/
│   ├── dataset_builder.py
│   ├── train_cb.py
│   ├── train_cf.py
│   └── train_ranker.py
├── online/
│   ├── api.py
│   ├── recommender.py
│   └── cache.py
├── features/
│   ├── content_features.py
│   ├── graph_features.py
│   └── behavior_features.py
└── evaluation/
    ├── offline_metrics.py
    └── ab_testing.py
```

---

## 🚀 部署与监控

- 容器化与灰度发布
- Prometheus + Grafana 监控指标
- A/B 实验框架与流量分配

---

*本文档定义个性化推荐系统的设计与评估方案，支撑智能导航系统的个性化功能。*
