# 变更即检流程 | Change-time Link QA Checklist

---

## 1. 适用范围 | Scope

- 新建文档 / 重命名 / 移动 / 大规模重构 / 导航结构调整

---

## 2. 提交前清单 | Pre-commit Checklist

- [ ] 相对路径逐条点击验证（同目录/上级/跨目录）
- [ ] 新建文档是否已加入对应导航/索引
- [ ] 新增/改名是否同步更新引用处
- [ ] 外链改动是否替换为稳定入口（必要时保留主词条）
- [ ] 文件末尾单一换行（避免MD047告警）

---

## 3. 快速自测 | Quick Self-test

1) 在 VSCode/预览中点击所有新改动链接
2) 对“深层条目与练习”类页面，额外点击 2 个内部段落锚点
3) 若包含目录级导航，随机抽检 4 条跨目录链接

---

## 4. 登记与回填 | Logging

- 将问题登记至《链接修复清单.md》（标注类型/位置/修复建议）
- 修复完成后，回填“✅ 修复完成 + 二次验证通过”

---

## 5. 交付与同步 | Delivery

- 在《进程上下文.md》追加一次性要点
- 涉及体系性规则的，补充至《格式标准化指南.md》

---

## 6. 自动化检查 | Automation (新增)

### 6.1 批量链接抽检（PowerShell）

```powershell
# 递归扫描仓库内的 md 文件并验证相对链接可达性
param(
  [string]$Root = "."
)

$ErrorActionPreference = "Stop"
$mdFiles = Get-ChildItem -Path $Root -Recurse -Include *.md

function Test-RelativeLink {
  param([string]$FilePath, [string]$Link)
  if ($Link -match '^(http|https)://') { return $true }
  $base = Split-Path -Parent $FilePath
  $target = Join-Path $base $Link
  return Test-Path $target
}

$results = @()
foreach ($f in $mdFiles) {
  $lines = Get-Content $f.FullName -Raw
  $matches = Select-String -InputObject $lines -Pattern "\[[^\]]+\]\(([^)]+)\)" -AllMatches
  foreach ($m in $matches.Matches) {
    $link = $m.Groups[1].Value
    if ($link -like "#*") { continue }
    $ok = Test-RelativeLink -FilePath $f.FullName -Link $link
    if (-not $ok) {
      $results += [pscustomobject]@{ File = $f.FullName; Link = $link }
    }
  }
}

if ($results.Count -gt 0) {
  "发现无效相对链接：$($results.Count) 条" | Write-Host -ForegroundColor Red
  $results | Format-Table -AutoSize | Out-String | Write-Host
  exit 1
} else {
  "链接检查通过" | Write-Host -ForegroundColor Green
}
```

### 6.2 改名/移动影响面清单（PowerShell）

```powershell
param([Parameter(Mandatory=$true)][string]$OldPath,
      [Parameter(Mandatory=$true)][string]$NewPath)

$all = Get-ChildItem -Recurse -Include *.md
foreach ($f in $all) {
  $content = Get-Content $f.FullName -Raw
  if ($content -match [regex]::Escape($OldPath)) {
    Write-Host "受影响: $($f.FullName)" -ForegroundColor Yellow
  }
}
Write-Host "请同步替换引用：$OldPath -> $NewPath" -ForegroundColor Cyan
```

### 6.3 自动化门禁建议

- 在 CI 中增加“变更即检”任务：
  - 扫描 PR 变更文件，运行 6.1/6.2
  - 阈值：无效链接数=0；改名未同步=0
  - 失败则阻断合并

---

## 7. 附：标准化检查清单（新增）

- [ ] 标题层级连续且有序（不跳级）
- [ ] 标题/路径/分层命名一致（与导航文件一致）
- [ ] 文件末尾仅保留一个换行（MD047）
- [ ] 代码块语言标注完整（便于高亮与工具识别）
